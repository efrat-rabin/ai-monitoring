name: PR Automation

on:
  pull_request:
    types: [opened, reopened, synchronize]
  pull_request_review_comment:
    types: [created]
  workflow_call:
    inputs:
      pr_number:
        description: 'PR number (auto-detected if not provided)'
        type: string
        required: false
      repository:
        description: 'Repository name (auto-detected if not provided)'
        type: string
        required: false
      test_mode:
        description: 'Run in test mode (uses mock data)'
        type: boolean
        required: false
        default: false
      demo:
        description: 'Run in demo mode (uses file-specific mock data)'
        type: boolean
        required: false
        default: false
    secrets:
      cursor_api_key:
        description: 'Cursor API key for AI analysis'
        required: true
      git_token:
        description: 'GitHub token for committing changes (defaults to GITHUB_TOKEN)'
        required: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Analyze when PR is opened or reopened (not on each new commit / synchronize)
  analyze:
    if: |
      github.event_name == 'pull_request' &&
      (github.event.action == 'opened' || github.event.action == 'reopened') &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        run: |
          echo "pr_number=${{ inputs.pr_number || github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "repository=${{ inputs.repository || github.repository }}" >> $GITHUB_OUTPUT
      
      - name: Checkout calling repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr_info.outputs.repository }}
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0
      
      - name: Checkout workflow repository
        uses: actions/checkout@v4
        with:
          repository: efrat-rabin/ai-monitoring
          path: .ai-monitoring
          # If the calling repo is this repo (ai-monitoring), use the PR SHA so we test the PR's scripts.
          # Otherwise (normal external usage), keep using the stable scripts from main.
          ref: ${{ github.repository == 'efrat-rabin/ai-monitoring' && (github.event.pull_request.head.sha || github.sha) || 'main' }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd .ai-monitoring
          pip install -r requirements.txt
      
      - name: Run analysis
        env:
          CURSOR_API_KEY: ${{ secrets.cursor_api_key }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_MODE: ${{ inputs.test_mode }}
          DEMO_MODE: ${{ inputs.demo }}
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}/.ai-monitoring/libs"
          cd ${GITHUB_WORKSPACE}
          
          # Build command with appropriate flags
          CMD="python .ai-monitoring/actions/analyze-pr-code/code_analyzer.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --context-lines 1"
          
          if [ "${{ inputs.demo }}" = "true" ]; then
            CMD="$CMD --demo"
          elif [ "${{ inputs.test_mode }}" = "true" ]; then
            CMD="$CMD --test-mode"
          fi
          
          eval $CMD
      
      - name: Post comment with results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/.ai-monitoring/libs:${PYTHONPATH}"
          python .ai-monitoring/actions/analyze-pr-code/post_comment.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --commit-sha ${{ github.event.pull_request.head.sha }} \
            --results-file analysis-results.json

  # Apply fixes when developer replies to a comment with /apply-logs
  apply-logs:
    concurrency:
      group: apply-logs-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: false
    if: |
      github.event_name == 'pull_request_review_comment' &&
      contains(github.event.comment.body, '/apply-logs')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        run: |
          echo "pr_number=${{ inputs.pr_number || github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "repository=${{ inputs.repository || github.repository }}" >> $GITHUB_OUTPUT
      
      - name: Checkout calling repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr_info.outputs.repository }}
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.git_token || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Debug checkout info
        run: |
          echo "Checked out commit: $(git rev-parse HEAD)"
          echo "Branch: $(git branch --show-current || echo 'detached HEAD')"
          echo "PR branch (latest SHA): ${{ github.event.pull_request.head.ref }}"
      
      - name: Checkout workflow repository
        uses: actions/checkout@v4
        with:
          repository: efrat-rabin/ai-monitoring
          path: .ai-monitoring
          # If the calling repo is this repo (ai-monitoring), use the PR SHA so we test the PR's scripts.
          # Otherwise (normal external usage), keep using the stable scripts from main.
          ref: ${{ github.repository == 'efrat-rabin/ai-monitoring' && (github.event.pull_request.head.sha || github.sha) || 'main' }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd .ai-monitoring
          pip install -r requirements.txt
      
      - name: Debug GitHub event context
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Comment ID: ${{ github.event.comment.id }}"
          echo "Comment in_reply_to_id: ${{ github.event.comment.in_reply_to_id }}"
          echo "Comment body: ${{ github.event.comment.body }}"
      
      - name: Check if apply should be triggered
        id: check_apply
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/.ai-monitoring/libs:${PYTHONPATH}"
          
          # Get comment IDs from event context
          COMMENT_ID="${{ github.event.comment.id }}"
          IN_REPLY_TO_ID="${{ github.event.comment.in_reply_to_id }}"
          
          # Debug output
          echo "Comment ID from event: '$COMMENT_ID'"
          echo "In-reply-to ID from event: '$IN_REPLY_TO_ID'"
          
          # Validate we have comment_id
          if [ -z "$COMMENT_ID" ]; then
            echo "ERROR: comment.id is not available in the event context"
            echo "This might happen if the workflow is not triggered by pull_request_review_comment event"
            echo "should_apply=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # If no in_reply_to_id, use comment_id itself
          if [ -z "$IN_REPLY_TO_ID" ]; then
            echo "No in_reply_to_id found, using comment_id as fallback"
            IN_REPLY_TO_ID="$COMMENT_ID"
          fi
          
          python .ai-monitoring/libs/comment_state.py check \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --comment-id "$COMMENT_ID" \
            --in-reply-to-id "$IN_REPLY_TO_ID"
      
      - name: Load parent comment
        if: steps.check_apply.outputs.should_apply == 'true'
        id: load_comment
        run: |
          PARENT_BODY=$(cat apply-trigger.json | jq -r '.parent_comment_body')
          echo "parent_body<<EOF" >> $GITHUB_OUTPUT
          echo "$PARENT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Apply suggested changes
        if: steps.check_apply.outputs.should_apply == 'true'
        id: apply_changes
        env:
          CURSOR_API_KEY: ${{ secrets.cursor_api_key }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/.ai-monitoring/libs:${PYTHONPATH}"
          cd ${GITHUB_WORKSPACE}
          
          # Write parent comment to file
          cat > parent-comment.txt << 'COMMENT_EOF'
          ${{ steps.load_comment.outputs.parent_body }}
          COMMENT_EOF
          
          python .ai-monitoring/actions/apply-suggested-logs/main.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --comment-body-file parent-comment.txt
      
      - name: Commit and push changes
        if: steps.check_apply.outputs.should_apply == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Checked out by branch ref, so we're on the latest SHA; just push
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          # Only add modified/deleted files (not temporary workflow files)
          git add -u
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MSG="${{ steps.apply_changes.outputs.commit_message }}"
            if [ -n "$COMMIT_MSG" ]; then
              git commit -m "$COMMIT_MSG"
              echo "✓ Committed with detailed message"
            else
              git commit -m "Apply AI-suggested logging improvements"
              echo "✓ Committed with default message"
            fi
            git push origin HEAD:"$PR_BRANCH"
          fi

      - name: Post success comment
        if: steps.check_apply.outputs.should_apply == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/.ai-monitoring/libs:${PYTHONPATH}"
          python .ai-monitoring/actions/apply-suggested-logs/post_apply_comment.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --comment-id "${{ github.event.comment.id }}"

      - name: Mark parent comment state
        if: steps.check_apply.outputs.should_apply == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/.ai-monitoring/libs:${PYTHONPATH}"
          PARENT_COMMENT_ID=$(jq -r '.parent_comment_id' apply-trigger.json)
          python .ai-monitoring/libs/comment_state.py set \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --parent-comment-id "$PARENT_COMMENT_ID" \
            --state applied

      # Pushes with GITHUB_TOKEN do not trigger new runs, so refresh-patches (synchronize) never runs after apply-logs. Run refresh here for applied files.
      - name: Refresh patches for applied files
        if: steps.check_apply.outputs.should_apply == 'true'
        continue-on-error: true
        env:
          CURSOR_API_KEY: ${{ secrets.cursor_api_key }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -s applied-files.txt ]; then
            echo "No applied-files.txt or empty, skipping refresh"
            exit 0
          fi
          echo "Refreshing patches for applied files:"
          cat applied-files.txt
          export PYTHONPATH="${GITHUB_WORKSPACE}/.ai-monitoring/libs:${PYTHONPATH}"
          python .ai-monitoring/actions/apply-suggested-logs/refresh_related_patches.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --refresh-all \
            --changed-files-file applied-files.txt

  # Refresh all ISSUE_DATA patches on pull_request.synchronize (human/bot PAT pushes). Apply-logs runs refresh in-job above.
  refresh-patches:
    if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
    concurrency:
      group: refresh-patches-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        run: |
          echo "pr_number=${{ inputs.pr_number || github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "repository=${{ inputs.repository || github.repository }}" >> $GITHUB_OUTPUT
      
      - name: Checkout calling repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr_info.outputs.repository }}
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.git_token || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Checkout workflow repository
        uses: actions/checkout@v4
        with:
          repository: efrat-rabin/ai-monitoring
          path: .ai-monitoring
          ref: ${{ github.repository == 'efrat-rabin/ai-monitoring' && (github.event.pull_request.head.sha || github.sha) || 'main' }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd .ai-monitoring
          pip install -r requirements.txt
      
      - name: Get files changed in trigger commit
        id: changed_files
        run: |
          git diff --name-only HEAD~1 HEAD 2>/dev/null || true > changed-files.txt
          echo "Changed files:"
          cat changed-files.txt || true
      
      - name: Count comments to refresh
        id: count_comments_to_refresh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/.ai-monitoring/libs:${PYTHONPATH}"
          OUTPUT=$(python .ai-monitoring/actions/apply-suggested-logs/refresh_related_patches.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --refresh-all \
            --count-only \
            --changed-files-file changed-files.txt 2>&1)
          echo "$OUTPUT"
          COUNT=$(echo "$OUTPUT" | grep '^COMMENTS_TO_REFRESH=' | sed 's/COMMENTS_TO_REFRESH=//' || echo '0')
          echo "count=$COUNT" >> $GITHUB_OUTPUT
      
      - name: Refresh patches for changed files
        if: steps.count_comments_to_refresh.outputs.count != '0'
        continue-on-error: true
        env:
          CURSOR_API_KEY: ${{ secrets.cursor_api_key }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/.ai-monitoring/libs:${PYTHONPATH}"
          python .ai-monitoring/actions/apply-suggested-logs/refresh_related_patches.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --refresh-all \
            --changed-files-file changed-files.txt

  # Generate monitor when developer comments /generate-monitor
  generate-monitor:
    if: |
      github.event_name == 'pull_request_review_comment' &&
      contains(github.event.comment.body, '/generate-monitor')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        run: |
          echo "pr_number=${{ inputs.pr_number || github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "repository=${{ inputs.repository || github.repository }}" >> $GITHUB_OUTPUT
      
      - name: Checkout workflow repository
        uses: actions/checkout@v4
        with:
          repository: efrat-rabin/ai-monitoring
          path: .ai-monitoring
          # If the calling repo is this repo (ai-monitoring), use the PR SHA so we test the PR's scripts.
          # Otherwise (normal external usage), keep using the stable scripts from main.
          ref: ${{ github.repository == 'efrat-rabin/ai-monitoring' && (github.event.pull_request.head.sha || github.sha) || 'main' }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd .ai-monitoring
          pip install -r requirements.txt
      
      - name: Generate monitor YAML and post preview
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURSOR_API_KEY: ${{ secrets.cursor_api_key }}
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}/.ai-monitoring:${GITHUB_WORKSPACE}/.ai-monitoring/libs"
          python .ai-monitoring/actions/apply-suggested-gc-resources/generate_monitor_yaml.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --comment-id "${{ github.event.comment.id }}"

  # Create monitor when developer comments /create-monitor
  create-monitor:
    if: |
      github.event_name == 'pull_request_review_comment' &&
      contains(github.event.comment.body, '/create-monitor')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        run: |
          echo "pr_number=${{ inputs.pr_number || github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "repository=${{ inputs.repository || github.repository }}" >> $GITHUB_OUTPUT
      
      - name: Checkout workflow repository
        uses: actions/checkout@v4
        with:
          repository: efrat-rabin/ai-monitoring
          path: .ai-monitoring
          # If the calling repo is this repo (ai-monitoring), use the PR SHA so we test the PR's scripts.
          # Otherwise (normal external usage), keep using the stable scripts from main.
          ref: ${{ github.repository == 'efrat-rabin/ai-monitoring' && (github.event.pull_request.head.sha || github.sha) || 'main' }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd .ai-monitoring
          pip install -r requirements.txt
      
      - name: Post monitor creation response
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .ai-monitoring/actions/apply-suggested-gc-resources/post_create_monitor_response.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --comment-id "${{ github.event.comment.id }}"

  # Generate dashboard when developer comments /generate-dashboard
  generate-dashboard:
    if: |
      github.event_name == 'pull_request_review_comment' &&
      contains(github.event.comment.body, '/generate-dashboard')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        run: |
          echo "pr_number=${{ inputs.pr_number || github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "repository=${{ inputs.repository || github.repository }}" >> $GITHUB_OUTPUT
      
      - name: Checkout workflow repository
        uses: actions/checkout@v4
        with:
          repository: efrat-rabin/ai-monitoring
          path: .ai-monitoring
          # If the calling repo is this repo (ai-monitoring), use the PR SHA so we test the PR's scripts.
          # Otherwise (normal external usage), keep using the stable scripts from main.
          ref: ${{ github.repository == 'efrat-rabin/ai-monitoring' && (github.event.pull_request.head.sha || github.sha) || 'main' }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd .ai-monitoring
          pip install -r requirements.txt
      
      - name: Post dashboard preview
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .ai-monitoring/actions/apply-suggested-gc-resources/post_dashboard_preview.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --comment-id "${{ github.event.comment.id }}"

  # Create dashboard when developer comments /create-dashboard
  create-dashboard:
    if: |
      github.event_name == 'pull_request_review_comment' &&
      contains(github.event.comment.body, '/create-dashboard')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr_info
        run: |
          echo "pr_number=${{ inputs.pr_number || github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "repository=${{ inputs.repository || github.repository }}" >> $GITHUB_OUTPUT
      
      - name: Checkout workflow repository
        uses: actions/checkout@v4
        with:
          repository: efrat-rabin/ai-monitoring
          path: .ai-monitoring
          # If the calling repo is this repo (ai-monitoring), use the PR SHA so we test the PR's scripts.
          # Otherwise (normal external usage), keep using the stable scripts from main.
          ref: ${{ github.repository == 'efrat-rabin/ai-monitoring' && (github.event.pull_request.head.sha || github.sha) || 'main' }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd .ai-monitoring
          pip install -r requirements.txt
      
      - name: Post dashboard creation response
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .ai-monitoring/actions/apply-suggested-gc-resources/post_create_dashboard_response.py \
            --pr-number ${{ steps.pr_info.outputs.pr_number }} \
            --repository ${{ steps.pr_info.outputs.repository }} \
            --comment-id "${{ github.event.comment.id }}"
